<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VR Library — Community Encyclopedia</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --paper:#FFF7EA; --ink:#2b2b2b; --muted:#6b645b; --accent:#7a4b1c; --accent-2:#b77b3d; --glass:rgba(255,255,255,0.65);
  --card-shadow: 0 6px 30px rgba(43,43,43,0.12);
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#efe7d3 0%, #f9f6f1 100%); color:var(--ink); -webkit-font-smoothing:antialiased}
.container{max-width:1150px; margin:28px auto; padding:0 20px}
.header{display:flex; align-items:center; gap:18px; background:var(--paper); padding:18px; border-radius:16px; box-shadow:var(--card-shadow); border:1px solid rgba(122,75,28,0.06)}
.brand{display:flex; align-items:baseline; gap:12px}
.logo-title{font-family:'Merriweather', serif; font-size:22px; font-weight:700; color:var(--accent)}
.logo-sub{font-size:13px; color:var(--muted)}
.searchbar{flex:1; position:relative}
.input{width:100%; padding:12px 16px; border-radius:12px; border:1px solid rgba(43,43,43,0.06); background:var(--glass); box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); font-size:15px}
.header-actions{display:flex; gap:10px; align-items:center}
.btn{background:linear-gradient(180deg,var(--accent) 0%, var(--accent-2) 100%); color:white; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; box-shadow:0 6px 20px rgba(183,123,61,0.15)}
.linkish{background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 10px; border-radius:8px; cursor:pointer}
.role-pill{padding:6px 8px; border-radius:8px; background:#f1e6d8; color:var(--accent); font-weight:600; font-size:13px}
.layout{display:grid; grid-template-columns:260px 1fr 300px; gap:20px; margin-top:20px}
.sidebar{background:rgba(255,255,255,0.7); padding:16px; border-radius:14px; border:1px solid rgba(43,43,43,0.03); box-shadow:0 8px 30px rgba(43,43,43,0.06)}
.h3{font-family:'Merriweather', serif; margin:0 0 10px 0}
.topic-list a{display:block; padding:8px 6px; color:var(--accent); text-decoration:none; border-radius:8px}
.topic-list a:hover{background:rgba(122,75,28,0.06)}
.filter-row{display:flex; gap:8px; flex-wrap:wrap}
.filter-chip{padding:8px 10px; border-radius:999px; background:transparent; border:1px solid rgba(43,43,43,0.06); cursor:pointer}
.feed{padding:16px; border-radius:14px; background:rgba(255,255,255,0.8); border:1px solid rgba(43,43,43,0.03); box-shadow:0 10px 30px rgba(43,43,43,0.04); min-height:60vh}
.post{display:flex; gap:14px; padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(249,246,241,0.9)); border:1px solid rgba(43,43,43,0.04); margin-bottom:12px; transition:transform .25s cubic-bezier(.2,.9,.3,1), box-shadow .25s}
.post:hover{transform:translateY(-6px); box-shadow:0 18px 40px rgba(43,43,43,0.08)}
.avatar{width:56px; height:56px; border-radius:10px; background:linear-gradient(180deg,#fff,#f4efe5); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent)}
.post-body{flex:1}
.post-title{font-family:'Merriweather', serif; font-size:18px; margin:0}
.post-meta{color:var(--muted); font-size:13px; margin-bottom:8px}
.post-content{color:#333; margin-bottom:10px}
.tags{display:flex; gap:8px; flex-wrap:wrap}
.tag{font-size:12px; padding:6px 8px; background:#f1e6d8; color:var(--accent); border-radius:8px}
.post-actions{display:flex; gap:8px; align-items:center}
.small{padding:6px 8px; border-radius:8px; background:transparent; border:1px solid rgba(43,43,43,0.05); cursor:pointer}
.rightcol{background:rgba(255,255,255,0.7); padding:16px; border-radius:14px}
.modal-backdrop{position:fixed; inset:0; display:none; background:rgba(9,8,6,0.45); align-items:center; justify-content:center}
.modal{width:720px; max-width:94%; background:var(--paper); border-radius:14px; padding:18px; box-shadow:0 30px 60px rgba(0,0,0,0.4); transform:scale(.98); opacity:0; transition:all .28s cubic-bezier(.2,.9,.3,1)}
.modal.show{transform:scale(1); opacity:1}
.form-row{display:flex; gap:10px}
.input-md{width:100%; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06)}
.textarea-md{width:100%; min-height:160px; padding:12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); resize:vertical}
.fade-in{animation:fadeIn .45s ease forwards}
@keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
@media (max-width:1000px){ .layout{grid-template-columns:1fr; } .rightcol{order:3} .sidebar{order:2} }
.center{display:flex; align-items:center; gap:10px}
.muted{color:var(--muted)}
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo-title">The VR Library</div>
      <div class="logo-sub">A community encyclopedia — elegant & persistent</div>
    </div>
    <div class="searchbar">
      <input id="globalSearch" class="input" placeholder="Search titles, tags, and content..." aria-label="Search">
    </div>
    <div class="header-actions">
      <div id="userInfo" class="center">
        <span id="userName" class="muted"></span>
      </div>
      <button id="signInBtn" class="btn" onclick="googleLogin()">Sign in with Google</button>
      <button id="newPostBtn" class="linkish">New Post</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <h3 class="h3">Collections</h3>
      <div class="topic-list" id="topicList"></div>
      <div style="height:12px"></div>
      <h3 class="h3">Filters</h3>
      <div class="filter-row" id="filterRow"></div>
      <div style="height:12px"></div>
      <h3 class="h3">Administration</h3>
      <div id="adminPanel"></div>
    </aside>

    <main class="feed" id="feed">
      <div id="postsContainer"></div>
    </main>

    <aside class="rightcol">
      <h3 class="h3">Trending tags</h3>
      <div id="trending"></div>
      <div style="height:18px"></div>
      <h3 class="h3">About</h3>
      <p class="muted">All posts are stored in Firestore and visible to everyone. Moderators and admins can manage content.</p>
    </aside>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="postModal">
    <h2>Create new post</h2>
    <div style="height:8px"></div>
    <div class="form-row">
      <input id="postTitle" class="input-md" placeholder="Title (required)">
      <select id="postCategory" class="input-md">
        <option value="General">General</option>
        <option value="VR Science">VR Science</option>
        <option value="History">History</option>
        <option value="Art">Art</option>
      </select>
    </div>
    <div style="height:8px"></div>
    <textarea id="postContent" class="textarea-md" placeholder="Write your article or note (HTML allowed)"></textarea>
    <div style="height:8px"></div>
    <input id="postTags" class="input-md" placeholder="Tags (comma separated)">
    <div style="height:12px"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px">
      <button id="cancelPost" class="linkish">Cancel</button>
      <button id="submitPost" class="btn">Publish</button>
    </div>
  </div>
</div>

<!-- Firebase + Google Sign-In + Firestore Logic -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBWlj0gA31boKWZ8Rukj7oSUZbIqUsY6Sk",
    authDomain: "tipidi-tapap.firebaseapp.com",
    projectId: "tipidi-tapap",
    storageBucket: "tipidi-tapap.firebasestorage.app",
    messagingSenderId: "607716485574",
    appId: "1:607716485574:web:52a976161569ac79a06ac7",
    measurementId: "G-WJNZNZ4Q9Q"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getFirestore(app);

  window.googleLogin = async () => {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const roleDoc = await getDoc(doc(db, 'roles', user.uid));
      if (!roleDoc.exists()) {
        await setDoc(doc(db, 'roles', user.uid), { role: 'user' });
      }
    } catch(err){ alert('Sign-in failed: '+err.message); }
  };

  window.googleLogout = async () => { await signOut(auth); };

  onAuthStateChanged(auth, async user => {
    window.currentUser = user;
    if(user){ document.getElementById('userName').textContent = user.displayName; document.getElementById('signInBtn').style.display='none'; } else { document.getElementById('userName').textContent=''; document.getElementById('signInBtn').style.display='inline-block'; }
  });

  document.getElementById('newPostBtn').addEventListener('click', ()=>{ if(!window.currentUser){ alert('Sign in first'); return; } document.getElementById('modalBackdrop').style.display='flex'; setTimeout(()=> document.getElementById('postModal').classList.add('show'),10); });
  document.getElementById('cancelPost').addEventListener('click', ()=>{ document.getElementById('postModal').classList.remove('show'); setTimeout(()=> document.getElementById('modalBackdrop').style.display='none',250); });

  document.getElementById('submitPost').addEventListener('click', async ()=>{
    const title=document.getElementById('postTitle').value.trim();
    const content=document.getElementById('postContent').value.trim();
    if(!title||!content){ alert('Title and content required'); return; }
    const tags=document.getElementById('postTags').value.split(',').map(s=>s.trim()).filter(Boolean);
    const category=document.getElementById('postCategory').value;
    await addDoc(collection(db,'posts'),{title,content,tags,category,author:{uid:window.currentUser.uid,name:window.currentUser.displayName},createdAt:serverTimestamp(),visible:true});
    document.getElementById('postTitle').value=''; document.getElementById('postContent').value=''; document.getElementById('postTags').value=''; document.getElementById('postCategory').value='General';
    document.getElementById('postModal').classList.remove('show'); setTimeout(()=> document.getElementById('modalBackdrop').style.display='none',250);
  });

  const postsQuery=query(collection(db,'posts'),orderBy('createdAt','desc'));
  onSnapshot(postsQuery,snap=>{
    const container=document.getElementById('postsContainer'); container.innerHTML='';
    snap.forEach(docSnap=>{
      const p=docSnap.data(); if(!p.visible)return;
      const el=document.createElement('div'); el.className='post';
      el.innerHTML=`<div class="avatar">${p.author?.name[0]||'A'}</div><div class="post-body"><h3>${p.title}</h3><p>${p.content}</p><small>By ${p.author.name}</small></div>`;
      container.appendChild(el);
    });
  });
</script>

</body>
</html>